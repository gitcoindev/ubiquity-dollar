name: Deep Fuzz
on:
  push:
  pull_request:

jobs:
  deep-fuzz:
    name: Deep Fuzz
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18.14.1"
          
      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: nightly-d369d2486f85576eec4ca41d277391dfdae21ba7

      - name: Get changed files
        uses: tj-actions/changed-files@v37

      - name: Deep Fuzz Solidity Contracts
        env:
          FOUNDRY_PROFILE: intense       
          run: |
            cd packages/contracts
            pwd
            for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
              echo "$file was changed"
            done
            echo "---------------------------"
            echo ${{ github.event_name }}
            echo "---------------------------"
            if ${{ github.event_name == 'pull_request' }}; then
              forge test
            fi
            if ${{ github.event_name == 'push' }}; then
              for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
                echo "$file was changed"
              done
            fi
